<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WAM-V Boat Dashboard</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }
        
        .container {
            display: flex;
            height: 100vh;
        }
        
        .map-container {
            flex: 1;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .sidebar {
            width: 350px;
            background: #1e1e1e;
            color: #fff;
            padding: 20px;
            overflow-y: auto;
        }
        
        .sidebar h2 {
            margin-bottom: 20px;
            color: #4CAF50;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        
        .telemetry-item {
            margin-bottom: 15px;
            padding: 10px;
            background: #2d2d2d;
            border-radius: 5px;
        }
        
        .telemetry-label {
            font-size: 12px;
            color: #aaa;
            text-transform: uppercase;
            margin-bottom: 5px;
        }
        
        .telemetry-value {
            font-size: 20px;
            font-weight: bold;
            color: #4CAF50;
        }
        
        .status {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
            text-align: center;
        }
        
        .status.connected {
            background: #4CAF50;
        }
        
        .status.disconnected {
            background: #f44336;
        }
        
        .waypoint-list {
            margin-top: 20px;
        }
        
        .waypoint-item {
            padding: 8px;
            margin-bottom: 8px;
            background: #2d2d2d;
            border-radius: 3px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="map-container">
            <div id="map"></div>
        </div>
        
        <div class="sidebar">
            <h2>ðŸš¤ WAM-V Telemetry</h2>
            
            <div id="status" class="status disconnected">
                Disconnected
            </div>
            
            <div class="telemetry-item">
                <div class="telemetry-label">Position</div>
                <div class="telemetry-value" id="position">--, --</div>
            </div>
            
            <div class="telemetry-item">
                <div class="telemetry-label">Heading</div>
                <div class="telemetry-value" id="heading">--Â°</div>
            </div>
            
            <div class="telemetry-item">
                <div class="telemetry-label">Speed</div>
                <div class="telemetry-value" id="speed">-- m/s</div>
            </div>
            
            <div class="telemetry-item">
                <div class="telemetry-label">Distance to Waypoint</div>
                <div class="telemetry-value" id="distance">-- m</div>
            </div>
            
            <div class="telemetry-item">
                <div class="telemetry-label">Wind Direction</div>
                <div class="telemetry-value" id="wind">--Â°</div>
            </div>
            
            <div class="waypoint-list">
                <h3 style="margin-top: 20px; margin-bottom: 10px; color: #4CAF50;">Waypoints</h3>
                <div id="waypoint-list"></div>
            </div>
        </div>
    </div>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- ROS WebSocket Bridge -->
    <script src="https://cdn.jsdelivr.net/npm/roslib@1.3.0/build/roslib.min.js"></script>
    
    <script>
        // ============================================
        // ROS Connection
        // ============================================
        const ros = new ROSLIB.Ros({
            url: 'ws://localhost:9090'
        });
        
        ros.on('connection', () => {
            console.log('Connected to ROS');
            document.getElementById('status').textContent = 'Connected';
            document.getElementById('status').className = 'status connected';
        });
        
        ros.on('error', (error) => {
            console.error('ROS Error:', error);
            document.getElementById('status').textContent = 'Error';
            document.getElementById('status').className = 'status disconnected';
        });
        
        ros.on('close', () => {
            console.log('Disconnected from ROS');
            document.getElementById('status').textContent = 'Disconnected';
            document.getElementById('status').className = 'status disconnected';
        });
        
        // ============================================
        // Map Initialization
        // ============================================
        // Initialize map centered on Sydney Harbour (VRX default location)
        const map = L.map('map').setView([-33.8568, 151.2153], 15);
        
        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);
        
        // Boat marker (will be updated in real-time)
        const boatIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34]
        });
        
        let boatMarker = L.marker([-33.8568, 151.2153], { icon: boatIcon }).addTo(map);
        
        // Waypoint marker
        const waypointIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41]
        });
        
        let waypointMarker = null;
        
        // Boat heading arrow (polyline)
        let headingLine = null;
        
        // ============================================
        // ROS Topic Subscribers
        // ============================================
        
        // GPS Position
        const gpsTopic = new ROSLIB.Topic({
            ros: ros,
            name: '/wamv/sensors/gps/gps/fix',
            messageType: 'sensor_msgs/NavSatFix'
        });
        
        gpsTopic.subscribe((message) => {
            if (message.latitude !== 0 && message.longitude !== 0) {
                const lat = message.latitude;
                const lon = message.longitude;
                
                // Update boat marker position
                boatMarker.setLatLng([lat, lon]);
                
                // Center map on boat (optional - can be toggled)
                // map.setView([lat, lon], map.getZoom());
                
                // Update position display
                document.getElementById('position').textContent = 
                    `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
            }
        });
        
        // Boat Pose (for heading)
        const poseTopic = new ROSLIB.Topic({
            ros: ros,
            name: '/wamv/pose',
            messageType: 'geometry_msgs/Pose'
        });
        
        poseTopic.subscribe((message) => {
            const q = message.orientation;
            
            // Calculate yaw (heading) from quaternion
            const yaw = Math.atan2(
                2.0 * (q.w * q.z + q.x * q.y),
                1.0 - 2.0 * (q.y * q.y + q.z * q.z)
            );
            
            const headingDeg = (yaw * 180 / Math.PI + 360) % 360;
            
            // Update heading display
            document.getElementById('heading').textContent = `${headingDeg.toFixed(1)}Â°`;
            
            // Update heading arrow on map
            const boatPos = boatMarker.getLatLng();
            if (boatPos) {
                // Calculate arrow endpoint (50m in heading direction)
                const arrowLength = 0.0005; // ~50 meters
                const latOffset = arrowLength * Math.cos(yaw);
                const lonOffset = arrowLength * Math.sin(yaw) / Math.cos(boatPos.lat * Math.PI / 180);
                
                const arrowEnd = [
                    boatPos.lat + latOffset,
                    boatPos.lng + lonOffset
                ];
                
                if (headingLine) {
                    headingLine.setLatLngs([boatPos, arrowEnd]);
                } else {
                    headingLine = L.polyline([boatPos, arrowEnd], {
                        color: 'blue',
                        weight: 3,
                        opacity: 0.7
                    }).addTo(map);
                }
            }
        });
        
        // Wind Direction
        const windTopic = new ROSLIB.Topic({
            ros: ros,
            name: '/vrx/debug/wind/direction',
            messageType: 'std_msgs/Float32'
        });
        
        windTopic.subscribe((message) => {
            const windDeg = (message.data * 180 / Math.PI + 360) % 360;
            document.getElementById('wind').textContent = `${windDeg.toFixed(1)}Â°`;
        });
        
        // Calculate speed from pose (simple approximation)
        let lastPose = null;
        let lastTime = Date.now();
        
        poseTopic.subscribe((message) => {
            const now = Date.now();
            const dt = (now - lastTime) / 1000.0; // seconds
            
            if (lastPose && dt > 0) {
                const dx = message.position.x - lastPose.position.x;
                const dy = message.position.y - lastPose.position.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                const speed = distance / dt;
                
                document.getElementById('speed').textContent = `${speed.toFixed(2)} m/s`;
            }
            
            lastPose = message;
            lastTime = now;
        });
        
        // ============================================
        // Waypoint Management
        // ============================================
        function setWaypoint(lat, lon) {
            if (waypointMarker) {
                waypointMarker.setLatLng([lat, lon]);
            } else {
                waypointMarker = L.marker([lat, lon], { icon: waypointIcon }).addTo(map);
            }
            
            // Draw line from boat to waypoint
            const boatPos = boatMarker.getLatLng();
            if (boatPos) {
                L.polyline([boatPos, [lat, lon]], {
                    color: 'red',
                    weight: 2,
                    dashArray: '5, 5',
                    opacity: 0.7
                }).addTo(map);
            }
            
            // Update waypoint list
            const waypointList = document.getElementById('waypoint-list');
            waypointList.innerHTML = `
                <div class="waypoint-item">
                    Target: ${lat.toFixed(6)}, ${lon.toFixed(6)}
                </div>
            `;
        }
        
        // Example: Set a waypoint (you can call this from console or button)
        // setWaypoint(-33.8573, 151.2158);
        
        // Listen for waypoint updates (if you publish waypoints to a topic)
        const waypointTopic = new ROSLIB.Topic({
            ros: ros,
            name: '/wamv/target_waypoint',
            messageType: 'geometry_msgs/Point'
        });
        
        waypointTopic.subscribe((message) => {
            // Assuming message has x=lat, y=lon
            setWaypoint(message.x, message.y);
        });
        
        console.log('Dashboard initialized. Waiting for ROS connection...');
    </script>
</body>
</html>

